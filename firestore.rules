rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ğŸ‘¤ Collection utilisateurs
    match /users/{userId} {
      // Tout utilisateur connectÃ© peut lire la collection ou un document
      allow read: if request.auth != null;
      
      // Seul le propriÃ©taire du profil peut Ã©crire dessus
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // NOUVELLE RÃˆGLE : Autoriser la lecture de la liste des utilisateurs
    match /users {
      allow list: if request.auth != null;
    }

    // ğŸ’¬ Collection conversations
    match /conversations/{conversationId} {
      // Lecture : participants peuvent lire
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // CrÃ©ation : utilisateur authentifiÃ© peut crÃ©er une conversation oÃ¹ il participe
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants;
      
      // Mise Ã  jour : participants peuvent modifier
      allow update: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Suppression : participants peuvent supprimer (incluant suppression lors de blocage)
      allow delete: if request.auth != null && 
        request.auth.uid in resource.data.participants;
    }

    // ğŸ’¬ Messages dans les conversations
    match /conversations/{conversationId}/messages/{messageId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
    }

    // ğŸš« Collection utilisateurs bloquÃ©s
    match /blocked_users/{blockId} {
      // Lecture : seulement le bloqueur peut voir ses bloquÃ©s
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.blockerId;
      
      // Ã‰criture : seulement le bloqueur peut bloquer/dÃ©bloquer
      allow create, update: if request.auth != null && 
        request.auth.uid == request.resource.data.blockerId;
      
      // Suppression : seulement le bloqueur peut dÃ©bloquer
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.blockerId;
    }

    // âš™ï¸ Configuration app (lecture publique, Ã©criture interdite)
    match /app_config/{document} {
      allow read: if true; // Lecture publique pour le chargement initial
      allow write: if false; // Seulement via Admin SDK
      
      // ğŸ“‹ Sous-collections dans app_config (comme games/list)
      match /{subcollection}/{subdocument} {
        allow read: if true; // Lecture publique pour toutes les sous-collections
        allow write: if false; // Seulement via Admin SDK
      }
    }

    // ğŸ® Collections de jeux (lecture publique)
    match /games/{gameId} {
      allow read: if true; // Lecture publique pour tous les jeux
      allow write: if false; // Seulement via Admin SDK
    }

    match /gameRanks/{rankId} {
      allow read: if true; // Lecture publique pour tous les rangs
      allow write: if false; // Seulement via Admin SDK
    }

    match /gameStyles/{styleId} {
      allow read: if true; // Lecture publique pour tous les styles
      allow write: if false; // Seulement via Admin SDK
    }

    match /timeSlots/{slotId} {
      allow read: if true; // Lecture publique pour tous les crÃ©neaux
      allow write: if false; // Seulement via Admin SDK
    }

    // ğŸ”„ Compteurs de messages non lus
    match /unreadCounts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“Š Stats et mÃ©tadonnÃ©es utilisateur
    match /userStats/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // La rÃ¨gle "catch-all" a Ã©tÃ© supprimÃ©e. 
    // Par dÃ©faut, tout ce qui n'est pas autorisÃ© ci-dessus est refusÃ©.
  }
}